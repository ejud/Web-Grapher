<!DOCTYPE HTML>
<html>
<head>
<title>Grapher</title>

<style type="text/css">
body {
	position: absolute;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	
	font-size: 18pt;
	font-family: 'Trebuchet MS',Arial,Helvetica,sans-serif;
}
.canvasWrapper {
	position: absolute;
	top: 2em;
	left: 0;
	bottom: 0;
	right: 0;
}
canvas.main {
	width: 100%;
	height: 100%;
	border: 1px solid #cccccc;
	cursor: crosshair;
}
.equationWrapper {
	margin-left: 1em;
}
label.equation {
	font-weight: bold;
}
input.equation, button.equation {
	font-size: inherit;
	font-family: inherit;
}
.errorDisplay {
	color: red;
	position: absolute;
	top: 0.5em;
	left: 0.5em;
}
.hidden {
	display: none;
}
#linkBox {
	width: 400px;
	font-size: inherit;
}
</style>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript" src="jquery.mousewheel.min.js"></script>
<script type="text/javascript" src="http://silentmatt.com/parser3.js"></script>
<script type="text/javascript">

var evalConstants = {
	e: 2.71828183
};


function getUrlVars() {
	var vars = [], hash;
	var hashes = window.location.href.slice (window.location.href.indexOf('?') + 1).split('&');
	for (var i = 0; i < hashes.length; i++) {
		hash = hashes[i].split('=');
		vars.push(hash[0]);
		vars[hash[0]] = hash[1];
	}
	return vars;
}

function getBaseUrl() {
	return window.location.href.split('?')[0];
};

function InteractiveGraph (elem, initialSize) {
	var canvas = $(elem);
	var parsedExpression = null;
	var vBounds = null;
	var lastMousePoint = null;
	
	var makePt = function (x, y) { return { x: x, y: y }; };
	
	var deprojectPoint = function (p) {
		if (!vBounds) return null;
		return {
			x: (p.x * vBounds.width() / canvas.attr('width')) + vBounds.left,
			y: vBounds.height() * (1.0 - (p.y / canvas.attr('height'))) + vBounds.bottom
		};
	};
	
	var projectPoint = function (p) {
		if (!vBounds) return null;
		return {
			x: (p.x - vBounds.left) * canvas.attr('width') / vBounds.width(),
			y: canvas.attr('height') * (1.0 - (p.y - vBounds.bottom) / vBounds.height())
		};
	};

	var errorHandlers = [];
	var error = function (err) {
		if (!err) err = null;
		for (var i = 0; i < errorHandlers.length; i++) {
			errorHandlers[i](err);
		}
	};
	this.error = function(f) {
		errorHandlers.push (f);
	};
	
	var draw = function() {
		var context = canvas[0].getContext('2d');
		
		context.clearRect (0, 0, canvas.width(), canvas.height());
		
		// Grid lines
		context.strokeStyle = '#000000';
		context.lineWidth = 0.5;
		
		context.beginPath();
		
		var p = projectPoint (makePt (vBounds.left, 0));
		context.moveTo (p.x, p.y);
		
		p = projectPoint (makePt (vBounds.right, 0));
		context.lineTo (p.x, p.y);
		
		p = projectPoint (makePt (0, vBounds.top));
		context.moveTo (p.x, p.y);
		
		p = projectPoint (makePt (0, vBounds.bottom));
		context.lineTo (p.x, p.y);
		
		// Tick marks
		context.font = '18px "Trebuchet MS",Arial,Helvetica,sans-serif';
		context.fillStyle = '#000000';
		var halfLength = 3;
		var intervalY = Math.ceil (vBounds.height() / 20);
		var intervalX = Math.ceil (vBounds.width() / 20);
		
		var maxTickY = Math.floor (vBounds.top / intervalY);
		var minTickY = Math.ceil (vBounds.bottom / intervalY);
			
		if (maxTickY == 0) maxTickY = -1;
		if (minTickY == 0) minTickY = 1;
	
		var maxTickX = Math.floor (vBounds.right / intervalX);
		var minTickX = Math.ceil (vBounds.left / intervalX);
		
		if (maxTickX == 0) maxTickX = -1;
		if (minTickX == 0) minTickX = 1;
		
		for (var i = minTickY; i <= maxTickY; i++) {
			if (i == 0) continue;
			
			var y = i * intervalY;
			p = projectPoint (makePt (0, y));
			if (p.x < 0) p.x = 0;
			if (p.x > canvas.width()) p.x = canvas.width();
			
			context.moveTo (p.x - halfLength, p.y);
			context.lineTo (p.x + halfLength, p.y);
			
			if (i == maxTickY) {
				context.fillText (y, p.x + halfLength + 1, Math.max (18, p.y + 4));
			}
			
			if (i == minTickY) {
				context.fillText (y, p.x + halfLength + 1, Math.min (canvas.height(), p.y + 4));
			}
		}
		
		for (var i = minTickX; i <= maxTickX; i++) {
			if (i == 0) continue;
			
			var x = i * intervalX;
			p = projectPoint (makePt (x, 0));
			if (p.y < 0) p.y = 0;
			if (p.y > canvas.height()) p.y = canvas.height();
			
			context.moveTo (p.x, p.y - halfLength);
			context.lineTo (p.x, p.y + halfLength);
			
			if (i == maxTickX) {
				context.fillText (x, Math.min (p.x, canvas.width() - 24), p.y - halfLength - 1);
			}
			
			if (i == minTickX) {
				context.fillText (x, p.x, p.y - halfLength - 1);
			}
		}
		
		context.stroke();
		context.closePath();
		
		if (!parsedExpression) return;
		
		// Graph itself
		context.strokeStyle = '#0000ff';
		context.lineWidth = 1.0;
		context.beginPath();
		
		var evalParam = evalConstants;
		var canvasWidth = canvas.attr ('width');
		for (var i = 0 ; i < canvasWidth; i++) {
			var vp = deprojectPoint (makePt (i, 0));
			try {
				evalParam.x = vp.x;
				vp.y = parsedExpression.evaluate (evalParam);
			} catch (e) {
				error ('Evaluation Error: ' + e.message);
				break;
			}
			
			var sp = projectPoint (vp);
			if (i == 0) {
				context.moveTo (sp.x, sp.y);
			} else {
				context.lineTo (sp.x, sp.y);
			}
		}
		
		context.stroke();
		context.closePath();
		
		// Hover Location
		if (lastMousePoint) {
			var vMousePt = deprojectPoint (lastMousePoint);
			var vGraphPt = vMousePt;
			evalParam.x = vMousePt.x;
			try {
				vGraphPt.y = parsedExpression.evaluate (evalParam);
				if (!vGraphPt.y) return;
			} catch (e) {
				return;
			}
			
			var sGraphPt = projectPoint (vGraphPt);
			
			var crosshairSize = 10;

			context.strokeStyle = '#ff0000';
			context.lineWidth = 0.5;
			context.beginPath();
			context.moveTo (sGraphPt.x - crosshairSize, sGraphPt.y);
			context.lineTo (sGraphPt.x + crosshairSize, sGraphPt.y);
			context.moveTo (sGraphPt.x, 0);
			context.lineTo (sGraphPt.x, canvas.height());
			context.stroke();
			context.closePath();
			
			context.font = '14px "Trebuchet MS",Arial,Helvetica,sans-serif';
			context.fillStyle = '#ff0000';
			context.fillText ('y = ' + vGraphPt.y, lastMousePoint.x + 5, lastMousePoint.y - 10);
		}
	};
	
	this.setExpression = function(exp) {
		try {
			error();
			var parser = new Parser();
			parsedExpression = parser.parse (exp);
		} catch (e) {
			error ('Parse Error: ' + e.message);
			parsedExpression = null;
		}
		draw();
	};
	
	var setBounds = function (top, bottom, left, right) {
		vBounds = {
			top: top,
			bottom: bottom,
			left: left,
			right: right,
			width: function() { return this.right - this.left; },
			height: function() { return this.top - this.bottom; }
		};
	};
	
	$(window).resize (function (e) {
		var w = canvas.width();
		var h = canvas.height();
		var aspect = w / h;
		
		// virtual
		var portalSize = (vBounds) ? Math.min (vBounds.width(), vBounds.height()) : initialSize;
		var centerX = 0;
		var centerY = 0;
		if (vBounds) {
			centerX = (vBounds.left + vBounds.right) / 2;
			centerY = (vBounds.top + vBounds.bottom) / 2;
		}
		var vw = (w < h) ? portalSize : (portalSize * aspect);
		var vh = (h < w) ? portalSize : (portalSize / aspect);
		setBounds (centerY + vh / 2, centerY - vh / 2, centerX - vw / 2, centerX + vw / 2);
		
		canvas.attr ('width', canvas.width());
		canvas.attr ('height', canvas.height());
		draw();
	});
	$(window).resize();
	
	this.resetView = function() {
		vBounds = null;
		$(window).resize();
	};
	
	canvas.mousemove (function (e) {
		lastMousePoint = makePt (e.offsetX, e.offsetY);
		draw();
	});
	
	canvas.mouseleave (function (e) {
		lastMousePoint = null;
		draw();
	});
	
	canvas.mousedown (function (e) {
		e.preventDefault();
		
		var downX = e.pageX;
		var downY = e.pageY;
		
		var widthRatio = canvas.width() / vBounds.width();
		var heightRatio = canvas.height() / vBounds.height();
		
		var downBounds = vBounds;
		
		var defaultCursor = $(this).css ('cursor');
		$(this).css ('cursor', 'move');
		var finish = function() {
			canvas.unbind('mousemove.drag');
			canvas.css ('cursor', defaultCursor);
		};
		
		$('*').bind ('mouseup.drag', function(e) {
			$('*').unbind ('mouseup.drag');
			finish();
		});
		
		canvas.bind ('mousemove.drag', function (e) {
			// Drag
			if (e.pageX && e.pageY) {
				vOffX = (downX - e.pageX) / widthRatio;
				vOffY = (e.pageY - downY) / heightRatio;
				setBounds (
					downBounds.top + vOffY,
					downBounds.bottom + vOffY,
					downBounds.left + vOffX,
					downBounds.right + vOffX);
			}
			draw();
		}).mousemove();
	});

	canvas.mousewheel (function (e, delta) {
		if (delta == 0) {
			return;
		}

		var base = 0.8;
		var factor = Math.pow(base, delta);

		var newWidth = vBounds.width() * factor;
		var newHeight = vBounds.height() * factor;

		var pivot = lastMousePoint ? deprojectPoint(lastMousePoint) : null;
		if (!pivot) {
			// Mouse wheel without a hover position? Seems weird, but what the heck.
			var x = (vBounds.left + vBounds.right) / 2;
			var y = (vBounds.top + vBounds.bottom) / 2;
			pivot = makePt(x, y);
		}

		// We want the zoom operation to "pivot" at the desired point.
		var newLeft = pivot.x - newWidth * (pivot.x - vBounds.left) / vBounds.width();
		var newBottom = pivot.y - newHeight * (pivot.y - vBounds.bottom) / vBounds.height();

		var newRight = newLeft + newWidth;
		var newTop = newBottom + newHeight;

		setBounds (
			newTop,
			newBottom,
			newLeft,
			newRight
		);
		draw();
	});
}

$('document').ready (function() {
	var exp = getUrlVars()['exp'];
	if (exp) {
		$('#equation').val (unescape(exp));
	}
	
	$('#createLink').click (function () {
		var exp = $('#equation').val();
		$('#linkBox').blur (function () {
			$(this).addClass ('hidden');
			$('#createLink').removeClass ('hidden');
		});
		$('canvas.main').mousedown (function () {
			$('#linkBox').blur();
		});
		$('#linkBox').keydown (function (e) {
			if (e.which == 27) {
				$(this).blur();
			}
		})
		$('#createLink').addClass ('hidden');
		$('#linkBox').val (getBaseUrl() + '?exp=' + escape(exp));
		$('#linkBox').removeClass ('hidden');
		$('#linkBox').focus();
		$('#linkBox').select();
	});
	
	var graph = new InteractiveGraph ($('canvas.main'), 20);
	graph.error (function (err) {
		if (!err) err = '';
		$('.errorDisplay').text (err);
	});
	
	$('#resetView').click (graph.resetView);
	$('#graphCurrentEquation').click (function () {
		$('form.equation').submit();
	});
	$('form.equation').submit (function () {
		graph.setExpression ($('#equation').val());
		return false;
	}).submit();
	$('#equation').select();
});

</script>
</head>

<body>
<div class="equationWrapper">
	<form class="equation">
		<label class="equation" for="equation">y = </label>
		<input class="equation" id="equation" value="sqrt(64-x*x)*sin(2*x)" />
		<button id="graphCurrentEquation" class="equation">Graph</button>
		<button id="resetView" class="equation">Reset View</button>
		<a href="javascript:void(0)" id="createLink">Link</a>
		<input type="text" readonly="readonly" class="hidden" id="linkBox" value="" />
	</form>
</div>
<div class="canvasWrapper">
	<canvas class="main"></canvas>
	<span class="errorDisplay"></span>
</div>

</body>

</html>
