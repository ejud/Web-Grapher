<!DOCTYPE HTML>
<html>
<head>
<title>Grapher</title>

<link rel="stylesheet" type="text/css" href="screen.css" />

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript" src="jquery.mousewheel.min.js"></script>
<script type="text/javascript" src="http://silentmatt.com/parser3.js"></script>

<script type="text/javascript" src="interactive-graph.js"></script>

<script type="text/javascript">

var evalConstants = {
	e: 2.71828183
};


function getUrlVars() {
	var vars = [], hash;
	var hashes = window.location.href.slice (window.location.href.indexOf('?') + 1).split('&');
	for (var i = 0; i < hashes.length; i++) {
		hash = hashes[i].split('=');
		vars.push(hash[0]);
		vars[hash[0]] = hash[1];
	}
	return vars;
}

function getBaseUrl() {
	return window.location.href.split('?')[0];
};

$('document').ready (function() {
	var exp = getUrlVars()['exp'];
	if (exp) {
		$('#equation').val (unescape(exp));
	}
	
	$('#createLink').click (function () {
		var exp = $('#equation').val();
		$('#linkBox').blur (function () {
			$(this).addClass ('hidden');
			$('#createLink').removeClass ('hidden');
		});
		$('canvas.main').mousedown (function () {
			$('#linkBox').blur();
		});
		$('#linkBox').keydown (function (e) {
			if (e.which == 27) {
				$(this).blur();
			}
		})
		$('#createLink').addClass ('hidden');
		$('#linkBox').val (getBaseUrl() + '?exp=' + escape(exp));
		$('#linkBox').removeClass ('hidden');
		$('#linkBox').focus();
		$('#linkBox').select();
	});
	
	var parsedExpression = null;

	var graph = new InteractiveGraph ($('canvas.main'), 20);
	graph.evaluatorProvider (function () {
		if (!parsedExpression) {
			return null;
		}

		var evalParam = evalConstants;
		return function(x) {
			if (!parsedExpression) {
				return null;
			}

			try {
				evalParam.x = x;
				return parsedExpression.evaluate (evalParam);
			} catch (e) {
				reportError('Evaluation Error: ' + e.message);

				// We'll unset the parsed expression now, because it's not really useful.
				// That way, next time through we won't try to parse it at all.
				parsedExpression = null;
				return null;
			}
		}
	})
	
	var reportError = function (err) {
		if (!err) err = '';
		$('.errorDisplay').text (err);
	};

	$('#resetView').click (graph.resetView);
	$('#graphCurrentEquation').click (function () {
		$('form.equation').submit();
	});
	$('form.equation').submit (function () {
		try {
			reportError('');

			var exp = $('#equation').val();
			var parser = new Parser();
			parsedExpression = parser.parse (exp);
		} catch (e) {
			reportError ('Parse Error: ' + e.message);
			parsedExpression = null;
		}

		graph.redraw();

		return false;
	}).submit();
	$('#equation').select();
});

</script>
</head>

<body>
<div class="equationWrapper">
	<form class="equation">
		<label class="equation" for="equation">y = </label>
		<input class="equation" id="equation" value="sqrt(64-x*x)*sin(2*x)" />
		<button id="graphCurrentEquation" class="equation">Graph</button>
		<button id="resetView" class="equation">Reset View</button>
		<a href="javascript:void(0)" id="createLink">Link</a>
		<input type="text" readonly="readonly" class="hidden" id="linkBox" value="" />
	</form>
</div>
<div class="canvasWrapper">
	<canvas class="main"></canvas>
	<span class="errorDisplay"></span>
</div>

</body>

</html>
